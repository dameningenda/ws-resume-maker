<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ヴァイスシュヴァルツ 履歴書メーカー</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- CSSエリア --- */
        :root {
            --primary-bg: #111;
            --primary-text: #fff;
            --border-color: #fff;
            --accent-color: #E60012; /* ヴァイスの赤 */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Noto Sans JP', sans-serif; -webkit-font-smoothing: antialiased; }

        body {
            background-color: #f0f2f5;
            color: #333;
            padding-bottom: 40px;
            overflow-x: hidden;
            width: 100%;
        }

        .container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        header {
            background: #000;
            color: #fff;
            padding: 15px;
            text-align: center;
            border-bottom: 4px solid var(--accent-color);
        }

        header h1 { font-size: 1.0rem; font-weight: 900; letter-spacing: 1px; }

        .page { display: none; padding: 20px; flex: 1; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Step 1: 選択画面 --- */
        .selection-group { margin-bottom: 30px; }
        h2 { font-size: 1.1rem; margin-bottom: 15px; text-align: center; font-weight: 900; }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .option-card {
            border: 2px solid #ddd;
            padding: 15px 5px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 900;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }

        .option-card.selected {
            border: 4px solid var(--accent-color) !important;
            background-color: #fff0f0;
            color: #000;
            transform: translateY(-2px);
        }
        .color-opt.selected { background-color: transparent; } 

        /* --- 履歴書キャンバス --- */
        .preview-wrapper { margin-bottom: 30px; }
        .preview-label { font-size: 0.8rem; font-weight: 900; color: #666; margin-bottom: 5px; text-align: center;}

        .preview-outer {
            width: 100%;
            background: #888;
            overflow: hidden;
            border-radius: 4px;
            border: 1px solid #ccc;
            position: relative;
        }

        /* 描画エリア */
        #capture-area {
            width: 1050px !important;
            min-width: 1050px !important;
            max-width: 1050px !important;
            height: 1350px !important;
            min-height: 1350px !important;
            max-height: 1350px !important;
            transform-origin: top left;
            background: #fff;
            overflow: hidden;
        }

        #resume-canvas {
            width: 1050px !important;
            min-width: 1050px !important;
            height: 1350px !important;
            min-height: 1350px !important;
            background: var(--primary-bg);
            color: var(--primary-text);
            padding: 40px 50px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ヘッダー周り */
        .resume-header-container { text-align: center; margin-bottom: 20px; flex-shrink: 0; }
        .resume-header {
            font-size: 65px;
            font-weight: 900;
            line-height: 1;
            margin-bottom: 10px;
            letter-spacing: 5px;
            white-space: nowrap;
        }
        .header-line {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
        }

        /* 上段: アイコンと情報 */
        .top-section {
            display: flex;
            gap: 25px; /* ギャップを少し詰める */
            margin-bottom: 10px;
            align-items: center;
            /* heightはJSで動的にセット */
            flex-shrink: 0;
        }

        .icon-area {
            width: 340px;
            min-width: 340px;
            height: 340px;
            min-height: 340px;
            border: 8px solid var(--border-color);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #333;
            position: relative;
        }
        .icon-area img { width: 100%; height: 100%; object-fit: cover; }
        #icon-placeholder { font-size: 40px; opacity: 0.5; color: #fff; font-weight: bold;}

        .info-grid {
            flex-grow: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px; /* グリッド間隔を詰める */
            height: 100%;
        }

        .field-box { 
            display: flex; 
            flex-direction: column; 
            min-width: 0;
            overflow: hidden; 
        }
        
        .field-label {
            font-size: 22px;
            font-weight: 900;
            margin-bottom: 2px; /* ラベル下の余白を詰める */
            margin-left: 5px;
            white-space: nowrap;
        }

        /* 入力エリアの基本スタイル */
        .field-value {
            background: #fff;
            color: #000;
            border: 5px solid var(--border-color);
            font-size: 32px; 
            font-weight: 900;
            padding: 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 65px; /* 【修正】高さを70px→65pxに圧縮 */
            min-height: 65px;
            line-height: 1.1;
            width: 100%;
            overflow: hidden; 
            white-space: nowrap;
            text-overflow: clip; 
        }

        .field-value.multiline {
            white-space: normal;
            word-break: break-all;
            line-height: 1.1; 
        }

        .field-value.large { 
            height: auto; 
            min-height: 90px; /* 少し詰める */
            max-height: 180px;
            padding: 5px; 
            white-space: normal; 
            line-height: 1.2;
            align-items: center;
        }

        /* スタイル欄 */
        .section-container { margin-bottom: 8px; flex-shrink: 0; }

        /* フリースペースのコンテナ (高さはJSで制御) */
        .fixed-height-container {
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .section-title { font-size: 34px; font-weight: 900; margin: 8px 0 4px; white-space: nowrap; }
        .style-box {
            background: #fff;
            color: #000;
            padding: 15px 20px;
            border: 6px solid var(--border-color);
            height: 230px;
            min-height: 230px;
            display: flex;
            align-items: center;
            overflow: hidden;
        }
        .checkbox-display-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px 10px;
            width: 100%;
        }
        .check-item {
            font-size: 22px;
            font-weight: 900;
            display: flex;
            align-items: center;
            opacity: 0.15;
            white-space: nowrap;
        }
        .check-item.checked { opacity: 1; }
        .check-mark {
            width: 26px;
            height: 26px;
            border: 4px solid #000;
            margin-right: 8px;
            position: relative;
            flex-shrink: 0;
        }
        .checked .check-mark::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 8px;
            border-left: 4px solid #000;
            border-bottom: 4px solid #000;
            top: 45%; 
            left: 50%;
            transform: translate(-50%, -60%) rotate(-45deg);
        }

        /* フリースペース本体：パディングと行間を詰めて文字サイズを確保 */
        .free-space {
            flex: 1;
            background: #fff;
            color: #000;
            padding: 10px 15px; /* 【修正】パディングをさらに削減してエリア確保 */
            font-size: 46px; 
            font-weight: 900;
            border: 6px solid var(--border-color);
            white-space: pre-wrap;
            line-height: 1.15; /* 【修正】行間をさらに詰めて大きく表示 */
            overflow: hidden;
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        /* --- 入力フォーム --- */
        .input-form-container {
            background: #fff;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .input-header {
            font-size: 1.2rem;
            font-weight: 900;
            border-left: 6px solid var(--accent-color);
            padding-left: 10px;
            margin-bottom: 20px;
        }

        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 900;
            margin-bottom: 8px;
            color: #333;
        }
        .form-group input[type="text"],
        .form-group textarea,
        .form-group input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            background: #fdfdfd;
        }
        .form-group input:focus, .form-group textarea:focus {
            border-color: var(--accent-color);
            outline: none;
        }

        .checkbox-input-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .checkbox-label {
            background: #f4f4f4;
            border: 1px solid #ccc;
            padding: 10px;
            font-size: 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-weight: 900;
            transition: 0.2s;
        }
        .checkbox-label.active {
            background: #333;
            color: #fff;
            border-color: #333;
        }
        .checkbox-label input { display: none; }

        /* --- ボタン類 --- */
        .action-area { margin-top: 30px; }
        .btn {
            display: block;
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 50px;
            font-weight: 900;
            cursor: pointer;
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.1rem;
            letter-spacing: 1px;
            transition: 0.2s;
        }
        .btn:disabled { background: #ccc !important; cursor: not-allowed; transform: none !important; }
        .btn.primary {
            background: var(--accent-color);
            color: #fff;
        }
        .btn.primary:active { transform: scale(0.98); }
        .btn.outline {
            background: #fff;
            color: #333;
            border: 2px solid #333;
        }
        .btn.sm { padding: 10px; font-size: 0.9rem; border-radius: 8px; background: #333; color: #fff; }

        /* --- 結果画面 --- */
        #result-area {
            text-align: center;
            margin: 20px 0;
            min-height: 200px;
            background: #eee;
            padding: 10px;
            border-radius: 8px;
        }
        #generated-image {
            max-width: 100%;
            height: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
        }

        .share-area {
            margin-top: 30px;
            border-top: 2px solid #eee;
            padding-top: 20px;
            text-align: center;
        }
        .share-area p { font-weight: 900; margin-bottom: 10px; }
        .tag-box {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: 900;
            word-break: break-all;
            user-select: all;
        }

        /* --- フッター --- */
        footer {
            padding: 20px;
            text-align: center;
            font-size: 0.8rem;
            color: #888;
            background: #fff;
            border-top: 1px solid #eee;
            margin-top: auto;
        }
        footer a { color: var(--accent-color); text-decoration: none; font-weight: 900; }

        /* --- ローディング --- */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #ccc;
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>ヴァイスシュヴァルツ 履歴書メーカー</h1>
        </header>

        <div id="step1" class="page active">
            <div class="selection-group">
                <h2>使用するテンプレートを選んでください</h2>
                <div class="selection-grid" id="template-selector">
                    <div class="option-card" onclick="selectTemplate('simple', this)">シンプル</div>
                    <div class="option-card" onclick="selectTemplate('social', this)">交流重視</div>
                    <div class="option-card" onclick="selectTemplate('push', this)">推し語り重視</div>
                </div>
            </div>

            <div class="selection-group">
                <h2>カラーを選んでください</h2>
                <div class="selection-grid" id="color-selector">
                    <div class="option-card color-opt" onclick="selectColor('weiss', this)" style="background:#111; color:#fff; border:1px solid #333;">ヴァイス<br>カラー</div>
                    <div class="option-card color-opt" onclick="selectColor('blau', this)" style="background:#F8FAFF; color:#1a3b5c; border:1px solid #1a3b5c;">ブラウ<br>カラー</div>
                    <div class="option-card color-opt" onclick="selectColor('rose', this)" style="background:#FFEFEF; color:#5c1a1a; border:1px solid #5c1a1a;">ロゼ<br>カラー</div>
                </div>
            </div>

            <div class="action-area">
                <button id="btn-to-step2" class="btn primary" onclick="goToStep2()" disabled>これで作る！</button>
            </div>
        </div>

        <div id="step2" class="page">
            <div class="preview-wrapper">
                <div class="preview-label">▼ 現在のプレビュー</div>
                <div class="preview-outer">
                    <div id="capture-area">
                        <div id="resume-canvas">
                            <div class="resume-header-container">
                                <div class="resume-header">ヴァイスシュヴァルツ<br>プロフィール</div>
                                <div class="header-line"></div>
                            </div>
                            <div id="canvas-top-area" class="top-section">
                                <div class="icon-area">
                                    <img id="preview-icon" src="" style="display:none;">
                                    <div id="icon-placeholder">No Image</div>
                                </div>
                                <div id="preview-info-grid" class="info-grid"></div>
                            </div>
                            <div class="section-container">
                                <div class="section-title">▼スタイル</div>
                                <div class="style-box">
                                    <div id="preview-styles" class="checkbox-display-group"></div>
                                </div>
                            </div>
                            <div id="free-space-container" class="section-container fixed-height-container">
                                <div class="section-title">▼フリースペース</div>
                                <div id="prev-freespace" class="free-space large"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-form-container">
                <h3 class="input-header">情報を入力する</h3>
                <div class="form-group">
                    <label>アイコン画像</label>
                    <input type="file" accept="image/*" onchange="updateIcon(this)">
                </div>
                <div id="dynamic-inputs"></div>
                <div class="form-group">
                    <label>プレイスタイル (複数選択可)</label>
                    <div id="style-inputs" class="checkbox-input-group"></div>
                </div>
                <div class="form-group">
                    <label>フリースペース</label>
                    <textarea id="input-freespace" oninput="updateText('freespace', this.value, true)" placeholder="自己紹介やプレイ頻度、メッセージなど自由に記入" rows="5"></textarea>
                </div>
                <div class="action-area">
                    <button id="gen-btn" class="btn primary" onclick="generateImage()">これで画像を生成する</button>
                    <button class="btn outline" onclick="goToStep1()">テンプレート選択に戻る</button>
                </div>
            </div>
        </div>

        <div id="step3" class="page">
            <h2 style="margin-top:20px;">これで画像を出力しますか？</h2>
            <div id="result-area">
                <img id="generated-image" alt="生成された履歴書">
            </div>
            <div class="action-area">
                <button id="download-btn" class="btn primary" onclick="downloadImage()">ダウンロードする</button>
                <button class="btn outline" onclick="backToEdit()">作成に戻る</button>
            </div>
            <div class="share-area">
                <p>X投稿用のハッシュタグはこちらからコピー！</p>
                <div class="tag-box" id="hashtag-text">#ヴァイス履歴書 #ヴァイス好きと繋がりたい</div>
                <button class="btn sm" onclick="copyHashtag()">ハッシュタグをコピーする</button>
            </div>
        </div>

        <footer>
            Created by <a href="https://x.com/damedame_dayo" target="_blank">だめにんげんだ！</a>
        </footer>
        
        <div id="loading-overlay">
            <div class="spinner"></div>
            <p>画像を生成中です...</p>
        </div>
    </div>

    <script>
        let currentTemplate = null;
        let currentColor = null;
        let generatedBlobUrl = null;

        const stylesList = [
            "ヴァイス本家", "ブラウ", "ロゼ", 
            "初心者", "エンジョイ", "真剣勝負",
            "コレクション", "対戦したい", "大会出ます",
            "デッキ相談したい", "リモートしたい", "YouTubeやってます",
            "ブログやってます", "リモート対戦募集", "趣味話したい"
        ];

        // 【最終調整】テンプレートごとの高さ設定
        // 上の項目欄をさらに圧縮し、フリースペースに回す
        // 全体のバランスを見直し、フリースペースの高さを確保
        const templateSettings = {
            'simple': {
                topHeight: '340px',
                freeSpaceHeight: '410px', 
                fields: [
                    { id: 'name', label: 'ハンドルネーム', span: 1, multiline: true },
                    { id: 'sex', label: '性別', span: 1 },
                    { id: 'title', label: '好きな参戦作品', span: 2, large: true }
                ]
            },
            'social': {
                topHeight: '480px', // 500 -> 480 (20px圧縮)
                freeSpaceHeight: '270px', // 250 -> 270 (20px拡大)
                fields: [
                    { id: 'name', label: 'ハンドルネーム', span: 1, multiline: true },
                    { id: 'sex', label: '性別', span: 1 },
                    { id: 'area', label: '活動地域', span: 1 },
                    { id: 'bushi', label: 'ブシナビコード', span: 1 },
                    { id: 'discord', label: 'Discord ID', span: 2 },
                    { id: 'title', label: '好きな参戦作品', span: 2, large: true }
                ]
            },
            'push': {
                topHeight: '500px', // 520 -> 500 (20px圧縮)
                freeSpaceHeight: '250px', // 230 -> 250 (20px拡大)
                fields: [
                    { id: 'name', label: 'ハンドルネーム', span: 1, multiline: true },
                    { id: 'sex', label: '性別', span: 1 },
                    { id: 'oshi', label: '推しキャラ', span: 2 },
                    { id: 'title', label: '好きな参戦作品', span: 2, large: true },
                    { id: 'future', label: '今後来てほしいタイトル', span: 2, large: true }
                ]
            }
        };

        const colorSettings = {
            'weiss': { bg: '#111', text: '#fff', border: '#fff' },
            'blau': { bg: '#F8FAFF', text: '#1a3b5c', border: '#1a3b5c' },
            'rose': { bg: '#FFEFEF', text: '#5c1a1a', border: '#5c1a1a' }
        };

        // --- functions ---
        function selectTemplate(t, el) {
            currentTemplate = t;
            document.querySelectorAll('#template-selector .option-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            checkReady();
        }
        function selectColor(c, el) {
            currentColor = c;
            document.querySelectorAll('#color-selector .option-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            checkReady();
        }
        function checkReady() {
            document.getElementById('btn-to-step2').disabled = !(currentTemplate && currentColor);
        }
        function goToStep1() { switchPage('step1'); }
        function goToStep2() {
            switchPage('step2');
            setTimeout(() => {
                resizePreview();
                setupCanvas();
            }, 100);
        }
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            window.scrollTo(0, 0);
        }
        function backToEdit() {
            switchPage('step2');
            setTimeout(resizePreview, 100);
        }
        function resizePreview() {
            const area = document.getElementById('capture-area');
            const outer = document.querySelector('.preview-outer');
            const scale = outer.offsetWidth / 1050;
            area.style.transform = `scale(${scale})`;
            outer.style.height = (1350 * scale) + "px";
        }
        window.addEventListener('resize', () => {
            if(document.getElementById('step2').classList.contains('active')){ resizePreview(); }
        });

        function setupCanvas() {
            const theme = colorSettings[currentColor];
            const config = templateSettings[currentTemplate];
            const canvas = document.getElementById('resume-canvas');
            
            canvas.style.setProperty('--primary-bg', theme.bg);
            canvas.style.setProperty('--primary-text', theme.text);
            canvas.style.setProperty('--border-color', theme.border);

            const topSection = document.getElementById('canvas-top-area');
            const freeSpaceContainer = document.getElementById('free-space-container');
            
            // 【重要】高さを適用する前にリセットする処理を入れる（バグ対策）
            topSection.style.height = ''; 
            freeSpaceContainer.style.height = ''; 
            
            setTimeout(() => {
                topSection.style.height = config.topHeight;
                topSection.style.minHeight = config.topHeight;
                freeSpaceContainer.style.height = config.freeSpaceHeight;
                freeSpaceContainer.style.minHeight = config.freeSpaceHeight;
            }, 10);

            const grid = document.getElementById('preview-info-grid');
            const inputs = document.getElementById('dynamic-inputs');
            grid.innerHTML = ''; 
            inputs.innerHTML = '';
            
            config.fields.forEach(f => {
                const extraClass = f.large ? 'large' : (f.multiline ? 'multiline' : '');
                grid.innerHTML += `
                    <div class="field-box" style="grid-column: span ${f.span}">
                        <div class="field-label">${f.label}</div>
                        <div class="field-value ${extraClass}" id="prev-${f.id}"></div>
                    </div>`;
                inputs.innerHTML += `
                    <div class="form-group">
                        <label>${f.label}</label>
                        <input type="text" oninput="updateText('${f.id}', this.value, true)" placeholder="${f.label}を入力">
                    </div>`;
            });

            const styleDisplay = document.getElementById('preview-styles');
            const styleInputs = document.getElementById('style-inputs');
            styleDisplay.innerHTML = ''; 
            styleInputs.innerHTML = '';
            
            stylesList.forEach((s, i) => {
                styleDisplay.innerHTML += `
                    <div class="check-item" id="disp-style-${i}">
                        <span class="check-mark"></span>${s}
                    </div>`;
                styleInputs.innerHTML += `
                    <label class="checkbox-label" id="label-style-${i}">
                        <input type="checkbox" onchange="toggleStyle(${i}, this)">${s}
                    </label>`;
            });

            // フリースペースのテキストを再反映（テンプレート切り替え時のバグ対策）
            const freeSpaceInput = document.getElementById('input-freespace');
            if (freeSpaceInput) {
                // 強制的にリサイズ処理を走らせる
                setTimeout(() => {
                    updateText('freespace', freeSpaceInput.value, true);
                }, 100);
            }
        }

        function updateText(id, val, isAutoFit) {
            const el = document.getElementById('prev-' + id);
            if (!el) return;
            el.innerText = val;
            
            if (isAutoFit) {
                let fontSize = 32; let minSize = 10;
                // 初期サイズ分岐
                if (el.classList.contains('free-space')) { 
                    fontSize = 46; 
                    // 【修正点】活動重視・推し語り版でも最小サイズを確保し、読める大きさを維持する
                    if (currentTemplate !== 'simple') {
                        minSize = 16; /* 14から16にアップ */
                    }
                } else if (el.classList.contains('large')) {
                    fontSize = 32;
                }

                el.style.fontSize = fontSize + "px";
                
                if (!el.classList.contains('large') && !el.classList.contains('multiline')) {
                    while (el.scrollWidth > el.clientWidth && fontSize > minSize) {
                        fontSize--;
                        el.style.fontSize = fontSize + "px";
                    }
                } else {
                    while (el.scrollHeight > el.clientHeight && fontSize > minSize) {
                        fontSize--;
                        el.style.fontSize = fontSize + "px";
                    }
                }
            }
        }

        function toggleStyle(index, cb) {
            const disp = document.getElementById('disp-style-' + index);
            const label = document.getElementById('label-style-' + index);
            if (cb.checked) { disp.classList.add('checked'); label.classList.add('active'); }
            else { disp.classList.remove('checked'); label.classList.remove('active'); }
        }

        function updateIcon(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.getElementById('preview-icon');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    document.getElementById('icon-placeholder').style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- 強力なサンドボックス画像生成 ---
        async function generateImage() {
            const loading = document.getElementById('loading-overlay');
            loading.style.display = 'flex';
            window.scrollTo(0, 0);

            const sandbox = document.createElement('div');
            sandbox.style.position = 'fixed';
            sandbox.style.top = '0';
            sandbox.style.left = '-9999px';
            sandbox.style.width = '1050px';
            sandbox.style.height = '1350px';
            sandbox.style.overflow = 'hidden';
            sandbox.style.zIndex = '-9999';
            document.body.appendChild(sandbox);

            const originalCanvas = document.getElementById('resume-canvas');
            const clone = originalCanvas.cloneNode(true);
            
            clone.style.width = '1050px'; 
            clone.style.minWidth = '1050px'; 
            clone.style.height = '1350px';
            clone.style.transform = 'none';
            clone.style.margin = '0';
            sandbox.appendChild(clone);

            try {
                await new Promise(r => setTimeout(r, 500));

                const canvas = await html2canvas(clone, {
                    scale: 1,
                    useCORS: true,
                    backgroundColor: colorSettings[currentColor].bg,
                    logging: false,
                    windowWidth: 1050, 
                    windowHeight: 1350
                });

                canvas.toBlob((blob) => {
                    if (generatedBlobUrl) URL.revokeObjectURL(generatedBlobUrl);
                    generatedBlobUrl = URL.createObjectURL(blob);
                    
                    const resultImg = document.getElementById('generated-image');
                    resultImg.src = generatedBlobUrl;
                    resultImg.style.display = "block";
                    
                    loading.style.display = 'none';
                    switchPage('step3');
                    
                    document.body.removeChild(sandbox);
                }, 'image/png');

            } catch (err) {
                console.error(err);
                alert("画像の生成に失敗しました。");
                loading.style.display = 'none';
                if(document.body.contains(sandbox)) {
                    document.body.removeChild(sandbox);
                }
            }
        }

        function downloadImage() {
            if (!generatedBlobUrl) return;
            const link = document.createElement('a');
            link.href = generatedBlobUrl;
            link.download = `WS_Resume_${Date.now()}.png`;
            link.click();
        }

        function copyHashtag() {
            const text = document.getElementById('hashtag-text').innerText;
            navigator.clipboard.writeText(text).then(() => alert("ハッシュタグをコピーしました！"));
        }
    </script>
</body>
</html>